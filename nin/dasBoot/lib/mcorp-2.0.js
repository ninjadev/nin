var MSV=function(g){!1==="performance"in window&&(window.performance={},window.performance.offset=(new Date).getTime());!1==="now"in window.performance&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset});var z=function(){return performance.now()/1E3},v=function(a,d){void 0===d&&(d=z());var m=d-a[3];return[a[0]+a[1]*m+0.5*a[2]*m*m,a[1]+a[2]*m,a[2],d]},t=function(a,d){if(a>d)return 1;if(a===d)return 0;if(a<d)return-1},A=function(a,d,m,j){if(0===m&&0===d)return a!=
j?[]:[0];if(0===m)return[(j-a)/d];var b;b=0<=Math.pow(d,2)-2*m*(a-j)?!0:!1;if(!1===b)return[];if(0===d*d-2*m*(a-j))return[-d/m];j=Math.sqrt(Math.pow(d,2)-2*m*(a-j));a=(-d+j)/m;d=(-d-j)/m;return[Math.min(a,d),Math.max(a,d)]},k=function(a,d,b,j){a=A(a,d,b,j);a=0===a.length?[]:1==a.length?0<a[0]?[a[0]]:[]:2==a.length?0>a[1]?[]:0<a[0]?[a[0],a[1]]:0<a[1]?[a[1]]:[]:[];return 0===a.length?null:a[0]},f=function(a,d){return a[0]-d[0]},b=function(a){var d=document.createElement("a");d.href=a;void 0===d.origin&&
(d.origin=d.protocol+"//"+d.host);return d},x=/^\d+$/;g.P=0;g.V=1;g.A=2;g.T=3;g.MsgType={MESSAGE:1,REQUEST:2,RESPONSE:3,EVENT:4};g.MsvCmd={CREATE:1,GET:2,UPDATE:3,DELETE:4,PING:5,PONG:6,UNSUB:7};g.client_clock=z;g.is_moving=function(a){return null===a?!1:0!==a[1]||0!==a[2]?!0:!1};g.compute_msv=v;g.compute_direction=function(a,d){var b=v(a,d),b=t(b[1],0);0===b&&(b=t(a[2],0));return b};g.compare_vectors=function(a,d){return[null===d[0]||d[0]==a[0],null===d[1]||d[1]==a[1],null===d[2]||d[2]==a[2],null===
d[3]||d[3]==a[3]]};g.calculate_delta=function(a,d,b){var j=a[0],f=a[1],h=a[2];a=k(j,f,h,d);j=k(j,f,h,b);return null!==a&&null!==j?a<j?[a,d]:[j,b]:null!==a?[a,d]:null!==j?[j,b]:[null,null]};g.calculate_interval=function(a,d){var b=a[MSV.P],j=a[MSV.V],f=a[MSV.A],h=b+j*d+0.5*f*d*d;if(0!==f){var p=-j/f;if(0<=p&&p<=d)return j=b-0.5*j*j/f,0<f?[j,Math.max(b,h)]:[Math.min(b,h),j]}return[Math.min(b,h),Math.max(b,h)]};g.calculate_solutions_in_interval=function(a,b,m){var j=[],k=a[MSV.P],h=a[MSV.V];a=a[MSV.A];
for(var p=0;p<m.length;p++)for(var l=m[p],s=A(k,h,a,l.point),e=0;e<s.length;e++){var q=s[e];0<=q&&q<=b&&j.push([q,l])}j.sort(f);return j};g.urlparse=function(a){if("string"!=typeof a)throw"URL must be a string, was a "+typeof a;var d={},f,j,k,h;if("msv://"!=a.substring(0,6))throw{name:"MsvUrlError",message:"protocol not supported  "+a.substring(0,6)};6<a.length&&"msv:///"===a.substring(0,7)?(j=!0,f=b("file"+a.slice(3)),k=""):(j=!1,f=b("http"+a.slice(3)),k=f.host);h="/"===f.pathname[0]?f.pathname.slice(1):
f.pathname;a="string"!==typeof h?!1:""===h?!0:x.test(h);if(!1===a)throw"illegal msvid : ["+h+"]";d.get_host=function(){return k};d.get_port=function(){return f.port};d.get_protocol=function(){return"msv:"};d.is_local=function(){return j};d.get_url=function(){if(d.is_local())return"msv:///"+h;var a=d.is_local()?"msv:///":"msv://",a=a+k;return""!==h?a+"/"+h:a};d.get_msvid=function(){return h};return d};g.href_to_location=b;return g}(MSV||{});MSV=function(g){var z=MSV.MsvCmd,v=MSV.MsgType,t,A=1,k=document.getElementsByTagName("head").item(0),f={};t={makeRequest:function(){var b={},x=[],a,d=A++,m,j,g=null,h=function(){var a,h;!f.hasOwnProperty(d)&&0<x.length&&(f[d]=b,m=document.createElement("script"),m.setAttribute("type","application/javascript"),m.setAttribute("charset","utf-8"),m.setAttribute("id","JscriptId"+d),m.async=!0,m.defer=!1,a=x.shift(),h=a.url,a=a.msg,j=MSV.client_clock(),a.hasOwnProperty("msg")&&a.cmd===z.PING&&(a.data=j),
a.cb="MSV.cb",a.reqid=d,a=encodeURIComponent(JSON.stringify(a)),h=h+"?data="+a+"&noCacheIE="+j,m.setAttribute("src",h),k.appendChild(m))};b.handle_result=function(d){k.removeChild(m);h();a&&a.call(b,d)};b.send=function(a,b){if(!b)throw"HTTPRequest: Send no message";x.push({url:a,msg:b});h()};b.close=function(){f.hasOwnProperty(d)&&delete f[d];m&&(k.removeChild(m),m=null);null!==g&&(clearTimeout(g),g=null)};b.is_sending=function(){return f.hasOwnProperty(d)||0<x.length};b.set_onresult=function(b){a=
b};return b},cb:function(b){if(b.hasOwnProperty("reqid")){var k=b.reqid;delete b.reqid;if(f.hasOwnProperty(k)){var a=f[k];delete f[k];a.handle_result(b)}}else throw"HTTPRequest: Missing reqid in response from server";}};g.IORemote=function(b,f){var a={};f=f||{};var d=f["to-connect"]||5,k=f["to-reconnect"]||10,j=f["to-ping"]||10,g;g=f["to-pong"]||2*j+1;var h=null,p=null,l=null,s=null,e=null,q=null,D=1E3*j,w={},n=0,C=null,Q=null;D||(D=1E4);var A=function(){null!==C&&(clearTimeout(C),C=null);L()},L=
function(){n+=1;3>n?this._tid=setTimeout(L,20):C=10>n?setTimeout(L,500):setTimeout(L,D);Q&&Q()};w.set_onping=function(c){Q=c};w.pause=function(){null!==C&&(clearTimeout(C),C=null)};w.resume=A;w.start=function(){n=0;A()};var r={},O=[],I=1E3,R=0;r.add_sample=function(c,a,e){O.push([c,a,e,(e-c)/2,a-(e+c)/2]);30<O.length&&O.shift();c=1E5;for(e=a=0;e<O.length;e++){var u=O[e];u[3]<c&&(c=u[3],a=u[4])}e=a!==R;I=c;R=a;e&&null!==l&&l()};r.get_server_clock=function(){return MSV.client_clock()+R};r.get_skew=
function(){return R};r.get_trans=function(){return I};var J,K;try{K="localStorage"in window&&null!==window.localStorage}catch(F){K=!1}var y=K?window.localStorage:void 0;J={getItem:function(c){if(K)return y.getItem(c)},setItem:function(c,a){try{K&&y.setItem(c,a)}catch(e){}}};var M=J.getItem("mcorp_ws_works");void 0===M&&(M="ws"===f.insist);var u="http"===f.insist?1:0,S=0,E=0,G=0,T=function(c){if(c!=E){var e=E;E=c;var u=!1;1===e&&2===c?(u=!0,G=0):2===e&&0===c?(console.log(new Date+": disconnected"),
u=!0):1===e&&0===c&&(G++,console.log(new Date+": connect failed "+G));u&&null!==h&&h.call(a)}},N=function(){0!==E&&(null!==s&&(s.set_onopen(void 0),s.set_onerror(void 0),s.set_onmessage(void 0),s.close(),s=null),null!==e&&(clearTimeout(e),e=null),null!==q&&(clearTimeout(q),q=null),w.pause(),T(0))},P=function(){if(0===E){if(M||"WebSocket"in window&&0===u){var c="wss://";!1===f.ssl&&(c="ws://");console.log(new Date+": connect "+c+b);var c=c+b,a={},q,j,J,h,D=function(c){q=null;h&&h.call(a,c)};a.send=
function(c){if(!q)return!1;try{q.send(JSON.stringify(c))}catch(a){return console.log(a),!1}return!0};a.close=function(){if(q)try{q.close()}catch(c){}};a.set_onopen=function(c){J=c};a.set_onerror=function(c){h=c};a.set_onmessage=function(c){j=c};q=new WebSocket(c);q.onmessage=function(c){j&&(c=JSON.parse(c.data),j.call(a,c))};q.onopen=function(){J&&J.call(a)};q.onerror=D;q.onclose=D;s=a;s.type="ws";u+=1}else{console.log(new Date+": connect http://"+b);var k="http://"+b,n={},l=null,w=null,g,G,m=null,
C=null,r=!1,p=function(){r&&!g.is_sending()&&g.send(C,{sid:m,op:"lp"})};n.send=function(c){return r?(c.sid=m,c.op="op",G.send(C,c),!0):!1};n.close=function(){r=!1;w=l=null;G.close();g.close()};n.set_onopen=function(c){l=c};n.set_onerror=function(){};n.set_onmessage=function(c){w=c};g=t.makeRequest();g.set_onresult(function(c){p();w&&c.hasOwnProperty("type")&&w.call(n,c)});G=t.makeRequest();G.set_onresult(function(c){var a;!1===r?(m=c.sid,a=MSV.href_to_location(k),a.port=c.port,C=a.href,console.log(C),
r=!0,p(),l&&l.call(n)):w&&c.hasOwnProperty("type")&&w.call(n,c)});G.send(k+"/createsession",{});s=n;s.type="http";S+=1}s.set_onopen(H);s.set_onerror(W);s.set_onmessage(X);e=setTimeout(Y,1E3*d);T(1)}},Y=function(){N();!1===M&&(1===u&&0===S)&&P()},H=function(){clearTimeout(e);e=null;!M&&"ws"===s.type&&(M=!0,J.setItem("mcorp_ws_works",!0));U();null!==q&&clearTimeout(q);q=setTimeout(c,1E3*(g+1))},U=function(){var c={type:v.REQUEST,cmd:z.PING,data:MSV.client_clock()};s.send(c)||N()};w.set_onping(function(){2===
E&&U()});var W=function(){N()},c=function(){N();P()},X=function(e){0!==E&&(e.cmd===z.PONG?(e=e.data,null!==q&&clearTimeout(q),q=setTimeout(c,1E3*g),r.add_sample(e[0],e[1],MSV.client_clock()),1==E&&(console.log(new Date+": connected"),T(2),w.start())):null!==p&&p.call(a,e))};P();setInterval(P,1E3*k);a.set_onconnect=function(c){h=c};a.set_onmessage=function(c){p=c};a.set_onskewchange=function(c){l=c};a.get_server_clock=r.get_server_clock;a.get_skew=r.get_skew;a.get_trans=r.get_trans;a.send=function(c){return 2===
E?(s.send(c),!0):!1};a.is_connected=function(){return 2===E?!0:!1};a.get_type=function(){return 2===E?s.type:null};a.get_host=function(){return b};a.get_url=function(){return"msv://"+b+"/"};a.connect=P;return a};g.cb=t.cb;g.HTTPRequest=t.makeRequest;return g}(MSV||{});MSV=function(g){var z=MSV.P,v=MSV.V,t=MSV.A,A=MSV.MsvCmd,k=MSV.MsgType,f=function(){var b={},f={},a=0,d=function(a){for(var b=[],d=0;d<a.length;d++){var k=a[d];f.hasOwnProperty(k)&&b.push(f[k])}return b},k=function(a){for(var b=[],d=MSV.client_clock(),k=0;k<a.length;k++){var l=a[k],s=l.msvid,e=l.vector,q=l.relative||!1,D=l.valid||null,l=f[s]||null;if(null===l||null!==D&&D!=l.eventid)return;var D=l.vector,w=MSV.compute_msv(D,d),n=e[z],g=e[v],e=e[t];!0===q?(n=null===n?w[z]:n+w[z],g=null===g?w[v]:g+
w[v],e=null===e?w[t]:e+w[t]):(null===n&&(n=w[z]),null===g&&(g=w[v]),null===e&&(e=w[t]));var q=l.range[0],m=l.range[1];null!==m&&n>=m?(n=m,0<g&&(g=0),0===g&&0<e&&(e=0)):null!==q&&n<=q&&(n=q,0>g&&(g=0),0===g&&0>e&&(e=0));l={msvid:s,eventid:l.eventid+1,old_vector:D,now_vector:w,vector:[n,g,e,d],range:l.range};f[s]=l;b.push(l)}return b};b.get_msvs=d;b.create_msvs=function(b){for(var g=0;g<b.length;g++){var h=a;a+=1;var A={msvid:h,eventid:0,range:b[g].range||[null,null]};b[g].msvid=h;var l=A.range[0];
A.vector=[null!==l?l:0,0,0,MSV.client_clock()];f[h]=A}for(g=[];0<b.length;)return b=b[0],h=null,h=b.hasOwnProperty("vector")&&null!==b.vector?k([b]):d([b.msvid]),null!==h&&(g=g.concat(h)),g};b.update_msvs=k;return b};g.IOLocal=function(){var b={},g=null,a=f(),d={},m={},j=function(a){m.hasOwnProperty(a)&&(clearTimeout(m[a]),delete m[a])};d.cancel_timeout=j;d.set_timeout=function(a,e,b,d,f){j(a);d=setTimeout(function(){f(a,e,b)},1E3*d);m[a]=d};var t=function(a){null!==g&&setTimeout(function(){g.call(b,
a)},0)},h=function(a){var e=a.msvid,b=a.eventid,f=MSV.calculate_delta(a.vector,a.range[0],a.range[1]);a=f[0];f=f[1];null!==a&&d.set_timeout(e,b,f,a,p)},p=function(a,e,b){l([{msvid:a,eventid:e,vector:[b,0,0]}])},l=function(b){b=a.update_msvs(b);for(var e=0;e<b.length;e++){var q=b[e],f=q.vector,g=q.old_vector,n=q.now_vector,j=MSV.is_moving(f),l=MSV.is_moving(g);q.mflags=[j,!0===j&&!1===l,!1===j&&!0===l];q.vflags=MSV.compare_vectors(g,f);q.uflags=MSV.compare_vectors(n,f);f=q.mflags[0];g=q.mflags[2];
q.mflags[1]?h(q):g?d.cancel_timeout(q.msvid):f&&h(q)}t({type:k.EVENT,cmd:A.UPDATE,data:b});return b};b.set_onmessage=function(a){g=a};b.set_onconnect=function(){};b.get_server_clock=MSV.client_clock;b.get_skew=function(){return 0};b.get_trans=function(){return 0};b.send=function(b){b.cmd==A.UPDATE?l(b.data):b.cmd==A.GET?(b={type:k.RESPONSE,cmd:A.GET,tunnel:b.tunnel||null,data:a.get_msvs(b.data)},t(b)):b.cmd==A.CREATE&&(b={type:k.RESPONSE,cmd:A.CREATE,tunnel:b.tunnel||null,data:a.create_msvs(b.data)},
t(b));return!0};b.is_connected=function(){return!0};b.get_type=function(){return"local"};b.get_host=function(){return""};b.get_url=function(){return"msv:///"};return b};g.makeMsvDB=f;return g}(MSV||{});try{!Object.prototype.__defineGetter__&&Object.defineProperty({},"x",{get:function(){return!0}}).x&&(Object.defineProperty(Object.prototype,"__defineGetter__",{enumerable:!1,configurable:!0,value:function(g,z){Object.defineProperty(this,g,{get:z,enumerable:!0,configurable:!0})}}),Object.defineProperty(Object.prototype,"__defineSetter__",{enumerable:!1,configurable:!0,value:function(g,z){Object.defineProperty(this,g,{set:z,enumerable:!0,configurable:!0})}}))}catch(defPropException){}
MSV=function(g){var z=MSV.P,v=MSV.V,t=MSV.A,A=MSV.T,k=MSV.MsvCmd,f=MSV.MsgType,b=function(a){this.name="MsvError";this.message=a||""};b.prototype=Error.prototype;var x=function(){this._token=void 0;this._confirmed=!1};x.prototype.refresh=function(a){this._token=a;this._confirmed=!1};x.prototype.confirm=function(){this._confirmed=!0};x.prototype.isConfirmed=function(){return this._confirmed};x.prototype.__defineGetter__("token",function(){return this._token});var a=function(a){return a.appid+"."+a.ticket},
d=function(e,d){function g(){u.push(performance.now());if(5>u.length)return!0;var c=0,a;for(a in u)if(2E3>performance.now()-u[a]){c=a-1;break}0<c&&u.splice(0,c);return 5<u.length?(console.log("WARNING: Too many updates, please check http://dev.mcorp.no for how to use motions in interactive settings"),!1):!0}var j={},n={},h={},l,m=d,t,r={},p={},I,v=function(c){return!c||(!c.vector||4!==c.vector.length)||!c.hasOwnProperty("eventid")||!c.hasOwnProperty("msvid")?!1:!0},J=function(c){if(!c||!c.hasOwnProperty("msvid")||
!c.vector)return!1;try{for(var a=0;3>a;a++)if(!(null===c.vector[a]||void 0===c.vector[a])){var b;var e=c.vector[a],u=parseFloat(e);b=!isNaN(u)&&isFinite(e)?u:null;if(null===b)return!1;c.vector[a]=b}}catch(d){return!1}return!0},K=function(c){var a=c[MSV.T]-e.get_skew();return[c[MSV.P],c[MSV.V],c[MSV.A],a]},F=function(c){return l.isConfirmed(c)},y={};l={refreshToken:function(c,a){setTimeout(function(){0<c.filter(function(c){return y.hasOwnProperty(c)&&y[c].token===a}).length&&a.forEach(function(c){p.hasOwnProperty(c)&&
p[c].api_msvclient.handle_token()})},a.expire-new Date);c.forEach(function(c){y.hasOwnProperty(c)||(y[c]=new x);y[c].refresh(a)})},confirmToken:function(c,e){c.forEach(function(c){if(!y.hasOwnProperty(c))throw new b("not tokenObject for given msvid "+c);a(y[c].token)===e&&y[c].confirm()})},getToken:function(c){return y.hasOwnProperty(c)?y[c].token:null},getMsvidListByToken:function(c){return Object.keys(y).filter(function(a){return y[a].token===c})},isConfirmed:function(c){return y.hasOwnProperty(c)?
y[c].isConfirmed():!1},sortByToken:function(c){var b,e={};c.forEach(function(c){b=a(y[c].token);e.hasOwnProperty(b)||(e[b]=[]);e[b].push(c)});return e}};var z=function(c){var a=c.msvid,b;if(r.hasOwnProperty(a)){var e=r[a];if(c.eventid<=e.eventid)return!1;b=MSV.compute_msv(e.vector,c.vector[A]);e.vector=c.vector;e.eventid=c.eventid;e.before_vector=b}else c.before_vector=c.vector,r[a]=c;p.hasOwnProperty(a)&&p[a].api_msvclient.handle_update();return!0},u=[],S=function(c,b){if(0===c.length)return!1;var e=
{type:f.REQUEST,cmd:k.GET,token:a(b),data:c};return t.do_request(e)},E=function(c,a){if("[object Object]"===a||"undefined.undefined"===a)throw Error("Bad token");if(e.is_connected())try{S(c,a)}catch(b){console.log("warning",b.message)}},G=function(c){return r.hasOwnProperty(c)},T=function(c){for(var a=[],b=0;b<c.length;b++){var e=c[b];p.hasOwnProperty(e)||(p[e]=s(n,e));a.push(p[e].api_public)}b=[];for(e=0;e<c.length;e++){var u=c[e];G(u)||b.push(u)}c=m;l.refreshToken(b,c);S(b,c);return a},N=function(c){return r.hasOwnProperty(c)?
K(r[c].vector):null},P=function(c){return r.hasOwnProperty(c)?(r[c].cred||[!0,!0,!0])[1]:null};j.get_msvs=T;j.get_msv=function(c){return 0<T([c]).length?[]:null};j.token_refresh=function(c){var a=l.getMsvidListByToken(m);m=c;l.refreshToken(a,c);E(a,c)};j.token_is_valid=F;n.token_refresh=function(c,a){if(new Date>a.expire)throw new b("token expired "+c);var e=[c];l.refreshToken(e,a);E(e,a)};n.token_is_valid=F;n.has_msv=G;n.query=function(c){c=N(c);return null!==c?MSV.compute_msv(c,MSV.client_clock()):
null};n.is_moving=function(c){c=N(c);return null!==c?MSV.is_moving(c):null};n.get_direction=function(c){c=N(c);return null!==c?MSV.compute_direction(c,MSV.client_clock()):null};n.update=function(c,u,d,q){c=[{msvid:c,vector:[u,d,q]}];if(!g())throw Error("Too many updates, ignored");var j=e.get_server_clock();u=[];for(d=0;d<c.length;d++)u.push(c[d].msvid);d=u.filter(G).length===u.length?!0:!1;if(!d)throw new b("prior GET has not yet succeeded");if(u.filter(P).length!==c.length)throw new b("write access has not been granted");
d=c.filter(J).length===c.length?!0:!1;if(!d)throw new b("illegal update parameter");var h,n={};c.forEach(function(c){h=a(l.getToken(c.msvid));n.hasOwnProperty(h)||(n[h]=[]);c.vector[A]=j;n[h].push(c)});for(h in n)c={cmd:k.UPDATE,token:h,data:n[h]},"1"===I?(c.type=f.MESSAGE,e.send(c)):"2"===I&&(c.type=f.REQUEST,t.do_request(c))};n.can_update=P;n.get_url=function(c){return null!==e?e.get_url()+c:null};n.get_range=function(c){return r.hasOwnProperty(c)?r[c].range:null};n.get_vector=N;n.get_original_vector=
function(c){return r.hasOwnProperty(c)?r[c].vector:null};n.get_before_vector=function(c){return r.hasOwnProperty(c)?K(r[c].before_vector):null};n.get_skew=function(){return null!==e?e.get_skew():null};n.get_latency=function(){return null!==e?e.get_trans():null};n.is_connected=function(){return null!==e?e.is_connected():!1};n.conn_type=function(){return null!==e?e.get_type():""};n.get_cred=function(c){if(r.hasOwnProperty(c)){c=r[c];var a="";(c.cred||[!0,!0,!0])[0]&&(a+="r");(c.cred||[!0,!0,!0])[1]&&
(a+="w");return a}return null};h.ontimeout=function(a){a.cmd===k.GET&&setTimeout(function(){console.log("ERROR:","GET timeout")},0)};var F={},B=0,H={},U=function(a){if(e.is_connected()&&H.hasOwnProperty(a)&&(a=H[a],!a.sent)){try{e.send(a.msg)}catch(b){return!1}return a.sent=!0}return!1},W=function(a){if(H.hasOwnProperty(a)){var b=H[a].tid;null!==b&&clearTimeout(b);delete H[a]}};F.get_reqid=function(){return B++};F.do_request=function(a){var b=B++;a.tunnel=b;var e=setTimeout(function(){if(H.hasOwnProperty(b)){var a=
H[b].msg;W(b);h.ontimeout(a)}},5E5);H[b]={msg:a,tid:e,sent:!1};return U(b)};F.handle_connect=function(){if(e.is_connected())for(var a in H)U(a)};F.handle_response=function(a){var b,e=a.tunnel;delete a.tunnel;H.hasOwnProperty(e)&&(b=H[e].msg,W(e));b&&delete b.tunnel;return b};t=F;e.set_onmessage(function(a){if(a.type===f.RESPONSE){var e=t.handle_response(a);if(!a.hasOwnProperty("cmd"))throw new b("illegal msg, cmd missing");a.cmd==k.GET&&void 0===I&&(I=a.v);"1"===I&&(a.status=0<a.data.length?200:404);
if(200===a.status){if(a.cmd===k.GET){var u=a.data.map(function(a){return a.msvid});l.confirmToken(u,e.token);for(e=0;e<a.data.length;e++)v(a.data[e])&&z(a.data[e])}}else setTimeout(function(){console.log("ERROR:",a.data)},0)}if(a.type===f.EVENT)for(e=0;e<a.data.length;e++)u=a.data[e],v(u)&&z(u)});e.set_onconnect(function(){t.handle_connect();var a=Object.keys(r);E(a,m);for(var b in p)p.hasOwnProperty(b)&&p[b].api_msvclient.handle_connect()});e.set_onskewchange(function(){for(var a in p)p.hasOwnProperty(a)&&
p[a].api_msvclient.handle_skewchange()});return j},m=null,j={},B=function(a,f,g){if(new Date>f.expire)throw new b("Token expired");if(""===a){if(null===m){if(!MSV.IOLocal)throw new b("Local Motion Not Supported");a=MSV.IOLocal();m=d(a,f)}return m}var h=a+"/"+f.appid;j.hasOwnProperty(h)||(a=MSV.IORemote(a,{ssl:g}),j[h]=d(a,f));return j[h]},h=function(a,b,d){return p([a],b,d)[0]},p=function(a,d,f){void 0===f&&(f=!0);if(!d.hasOwnProperty("appid"))throw new b("Illegal token, must specify 'appid'");if(!d.hasOwnProperty("user"))if(d.hasOwnProperty("ticket"))d.user=
d.ticket;else throw new b("Illegal token, must specify 'user'");if(!d.hasOwnProperty("expire"))throw new b("Illegal token, must specify 'expire'");if(new Date>d.expire)throw new b("Token expired");for(var g,h,j=[],k={},l=0;l<a.length;l++){g=MSV.urlparse(a[l]);h=g.get_host();g=g.get_msvid();k.hasOwnProperty(h)||(k[h]=[]);if(""===g)throw new b("msvid is empty string");k[h].push(g)}for(h in k)k.hasOwnProperty(h)&&(a=B(h,d,f),j=j.concat(a.get_msvs(k[h])));return j},l=Object.freeze({INIT:"init",CONNECTING:"connecting",
EXPIRED:"expired",OPEN:"open",CLOSED:"closed"}),s=function(a,d){var f={},g={},h,k=l.INIT;h={set:function(a){k!==l.CLOSED&&a!==k&&(k=a,r("readystatechange",a))},get:function(){return k}};var j=function(){if(a.has_msv(d))if(a.token_is_valid(d)){var b=a.is_connected()?l.OPEN:l.CONNECTING;h.set(b)}else h.set(l.EXPIRED)},m=null,p={readystatechange:[],change:[],timeupdate:[],error:[],skewchange:[]},r=function(a,e,f){if(!p.hasOwnProperty(a))throw new b("Unsupported event "+a);for(var h,g=0;g<p[a].length;g++){h=
p[a][g];if(void 0===f){if(h["_immediate_pending_"+a+d])continue}else if(h===f)f["_immediate_pending_"+a+d]=!1;else continue;try{h.call(h["_ctx_"+a+d],e)}catch(u){console.log("Error in "+a+": "+h+": ",u)}}},s=function(){return h.get()!==l.CLOSED&&h.get()!==l.INIT},x=function(){var b;b=a.query(d);b=null===b?null:{pos:b[MSV.P],vel:b[MSV.V],acc:b[MSV.A],ts:b[MSV.T]};return b},B=function(){return s()?{readyState:h.get(),latency:a.get_latency(),skew:a.get_skew(),range:a.get_range(d),connType:a.conn_type(),
src:a.get_url(d),vector:a.get_vector(d),lastVector:a.get_before_vector(d),cred:a.get_cred(d)}:{readyState:h.get(),latency:a.get_latency(),skew:a.get_skew(),connType:a.conn_type(),src:a.get_url(d)}};g.handle_update=function(){j();var b=x();r("change",b);r("timeupdate",b);(b=a.is_moving(d))&&null===m?m=setInterval(function(){r("timeupdate",x())},200):!b&&null!==m&&(clearTimeout(m),m=null)};g.handle_connect=function(){j()};g.handle_error=function(a){h.set(l.CLOSED);r("error",a)};g.handle_token=function(){j()};
g.handle_skewchange=function(){r("skewchange",void 0)};f.__defineGetter__("STATE",function(){return l});f.query=x;f.update=function(b,f,h,g){return"object"===typeof b&&null!==b&&void 0!==b?a.update(d,b.position,b.velocity,b.acceleration):a.update(d,b,f,h,g)};f.isMoving=function(){return s()?a.is_moving(d):null};f.getDirection=function(){return s()?a.get_direction(d):null};f.tokenRefresh=function(){return s()?a.token_refresh(d):null};f.__defineGetter__("pos",function(){return x().pos});f.__defineGetter__("vel",
function(){return x().vel});f.__defineGetter__("acc",function(){return x().acc});f.getState=B;f.getInfo=B;f.on=function(a,e,g){if(!e||"function"!==typeof e)throw new b("Illegal handler");"vectorchange"===a&&(a="change");if(!p.hasOwnProperty(a))throw new b("Unsupported event "+a);-1===p[a].indexOf(e)&&(e["_ctx_"+a+d]=g||f,p[a].push(e),e["_immediate_pending_"+a+d]=!0,setTimeout(function(){"readystatechange"===a?r("readystatechange",h.get(),e):"change"===a?h.get()===l.INIT?e["_immediate_pending_"+a+
d]=!1:r("change",x(),e):"timeupdate"===a?h.get()===l.INIT?e["_immediate_pending_"+a+d]=!1:r("timeupdate",x(),e):"error"===a?e["_immediate_pending_"+a+d]=!1:"skewchange"===a&&(h.get()===l.INIT?e["_immediate_pending_"+a+d]=!1:r("skewchange",void 0,e))},0));return f};f.off=function(a,b){if(void 0!==p[a]){var d=p[a].indexOf(b);-1<d&&p[a].splice(d,1)}return f};f.__defineGetter__("readyState",h.get);f.__defineGetter__("msvid",function(){return d});f.__defineGetter__("id",function(){return d});f.__defineGetter__("src",
function(){return a.get_url(d)});Object.defineProperty(f,"skew",{get:function(){return a.get_skew()}});Object.defineProperty(f,"vector",{get:function(){var b=a.get_original_vector(d);return{position:b[z],velocity:b[v],acceleration:b[t],timestamp:b[A]}}});Object.defineProperty(f,"range",{get:function(){var b=a.get_range(d);null===b[0]&&(b[0]=-Infinity);null===b[1]&&(b[1]=Infinity);return b}});j();return{api_public:f,api_msvclient:g}};g.msv=h;g.get_msvs=p;g.token_refresh=function(a){if(!(new Date>a.expire)){var b,
d;for(d in j)j.hasOwnProperty(d)&&(b=j[d],b.token_refresh(a))}};g.get_msv=h;g.msvclient=d;g.msvproxy=s;g.get_msvclient=B;return g}(MSV||{});var MCorp=function(g){!1==="performance"in window&&(window.performance={},window.performance.offset=(new Date).getTime());!1==="now"in window.performance&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset});var z={get:function(g,k,f){var b=new XMLHttpRequest;g+="?";for(var t in k)g+=t+"="+k[t]+"&";b.open("GET",g,!0);b.onreadystatechange=function(){4==b.readyState&&f(JSON.parse(b.response))};b.send()}},v=function(){var g=0,k,f=this,b={};return{get:function(t,a,
d,m){var j=-1===(t||"").indexOf("?")?"?":"&",v;callbackName=b.callbackName||"callback";var h=callbackName+"_json"+ ++g;a=a||{};for(v in a)a.hasOwnProperty(v)&&(j+=encodeURIComponent(v)+"="+encodeURIComponent(a[v])+"&");f[h]=function(a){d&&d(a);try{delete f[h]}catch(b){}f[h]=null};var p=t+j+callbackName+"="+h,l=document.createElement("script"),s=!1;l.src=p;l.async=!0;var e=m||b.error;"function"===typeof e&&(l.onerror=function(a){e({url:p,event:a})});l.onload=l.onreadystatechange=function(){if(!s&&
(!this.readyState||"loaded"===this.readyState||"complete"===this.readyState))s=!0,l.onload=l.onreadystatechange=null,l&&l.parentNode&&l.parentNode.removeChild(l)};k||(k=document.getElementsByTagName("head")[0]);k.appendChild(l);return h},init:function(f){b=f}}}(),t=Object.freeze({INIT:"init",USER:"user",CTX:"context",OPEN:"open",CLOSED:"closed"});g.app=function(g,k){var f={run:null},b,x,a={},d,m=!1,j,B;k=k||{};k.role=k.role||"default";k.xhr&&(console.log("USE XHR, not JSONP"),v=z);var h={},p,l=t.INIT;
k.profile&&(h.state_init=performance.now());p={set:function(a){found=!1;for(var b in t)t.hasOwnProperty(b)&&t[b]===a&&(found=!0);if(!found)throw Error("Illegal state value "+a);l!==t.CLOSED&&a!==l&&(l=a,e("readystatechange",a))},get:function(){return l}};var s={readystatechange:[],cancast:[],castbusy:[]},e=function(a,b,d){if(!s.hasOwnProperty(a))throw"Unsupported event "+a;for(var e,g=0;g<s[a].length;g++){e=s[a][g];if(void 0===d){if(e._immediate_pending)continue}else if(e===d)d._immediate_pending=
!1;else continue;try{e.call(f,b)}catch(h){throw console.log("Error in "+a+": "+e+": ",h),Error("Error in "+a+": "+e+": "+h);}}},q=function(a,b){if(void 0!==s[a]){var d=s[a].indexOf(b);-1<d&&s[a].splice(d,1)}return f},D=function(a,b){if(!b||"function"!==typeof b)throw"Illegal handler";if(!s.hasOwnProperty(a))throw"Unsupported event "+a;-1===s[a].indexOf(b)&&(s[a].push(b),setTimeout(function(){"readystatechange"===a&&(b._immediate_pending=!0,e(a,p.get(),b));"cancast"===a&&m&&(b._immediate_pending=!0,
e(a,m,b));"castbusy"===a&&void 0!==j&&(b._immediate_pending=!0,e(a,j,b))},0));return f},w=function(){k.profile&&(h.state_open=performance.now());p.set(t.OPEN);if(null!==f.run)try{f.run.call(f)}catch(a){n(a),console.log("Error in ready handler:",a.stack||a)}},n=function(a){p.set(t.CLOSED);throw Error("Context failed:"+a+","+a.stack||"");},C=function(){k.profile&&(h.request_contextStart=performance.now());var a=(new Date).getTime(),b,d={app_id:g,role:k.role,referrer:window.location};k.anon&&(d.anon=
!0);v.get("https://dev.mcorp.no/magic.py/get_context",d,function(e){k.profile&&(h.request_contextSuccess=performance.now());b=(new Date).getTime();"signin"===e.error?window.location=e.url:"error"===e.result?n(e.message):(Q(e,a,b),x=e.logout_url,K(e),y("https://dev.mcorp.no/magic.py/get_context",d),p.set(t.CTX),k.profile&&(h.state_context=performance.now()))},n)},Q=function(a,d,e){b={appid:g,ticket:a.t,expire:new Date(1E3*a.exp-(1E3*a.ts-(e+d)/2))}},V=function(a,b){d?a({result:"success",sid:d}):v.get("https://dev.mcorp.no/magic.py/get_session",
{app_id:g,referrer:window.location},a,b)},L,r,O=1E3,I=function(a){void 0===h.skew&&(h.skew=[],r=performance.now());if(null===a.getState())setTimeout(function(){I(a)},10);else{var b=a.getInfo();O!=b.latency&&(O=b.latency,h.skew.push({time:performance.now(),skew:b.skew,latency:b.latency}));5E3>performance.now()-r&&setTimeout(function(){I(a)},50);return!0}},R=!1,J=function(a,b){b=this;if(!R)try{R=I(b)}catch(d){alert(d)}a===b.STATE.OPEN&&(L-=1,0===L&&(w(),k.profile&&(h.initialize_msvsEnd=performance.now())),
b.off("readystatechange",J))},K=function(d){k.profile&&(h.initialize_msvsStart=performance.now());var e=[],f={},g;for(g in d.ms)d.ms.hasOwnProperty(g)&&(e.push(d.ms[g].url),f[d.ms[g].url]=d.ms[g].nick);L=e.length;if(0===L)setTimeout(w,0),k.profile&&(h.initialize_msvsEnd=performance.now());else{var e=MSV.get_msvs(e,b,k.ssl),j;for(j in e)if(e.hasOwnProperty(j)){d=e[j];g=f[d.src];if(void 0===g)throw Error(g+" is undefined");a[g]=d;d.on("readystatechange",J)}}},F=0,y=function(a,d,e){void 0===e&&(e=!0);
var f,g,h=function(h){F--;g=(new Date).getTime();Q(h,f,g);MSV.token_refresh(b);y(a,d,e)},j=function(b){F--;console.log("token refresh failed - will try again in 1 min: ",b);setTimeout(function(){y(a,d)},6E4)},k=Math.max(0,b.expire-new Date-3E5);(0!==k||e)&&setTimeout(function(){if(!(0<F)){F++;f=(new Date).getTime();try{v.get(a,d,h,j)}catch(b){j(b)}}},k)},M=function(a,b,f){if(k.castNoSesson)session=void 0;else{if(void 0===d){V(function(e){"error"===e.result?f&&f(e.message):(d=e.sid,M(a,b,f))});return}session=
d}B.sendMessage("urn:x-cast:no.mcorp.castinmotion",{url:a||k.castURL,session:session},function(){j=!0;e("castbusy",!0);b&&b(a||k.castURL)},function(a){console.log(a);f&&f(a)})};f.__defineGetter__("readyState",p.get);f.__defineGetter__("STATE",function(){return t});f.__defineGetter__("appid",function(){return g});f.__defineGetter__("motions",function(){return a});f.__defineGetter__("logoutUrl",function(){return x});f.__defineGetter__("token",function(){return b});f.__defineGetter__("ctx",function(){return{msvs:a}});
f.__defineGetter__("msvs",function(){return a});f.__defineGetter__("profile",function(){return h});f.on=D;f.off=q;f.init=function(){k.profile&&(h.initStart=performance.now());var a;a="_sid_".replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(location.search);if((a=null===a?"":decodeURIComponent(a[1].replace(/\+/g," ")))&&!k.ignoreSession){d=a;k.profile&&(h.request_groupcontextStart=performance.now());var b=(new Date).getTime(),g,l={sid:a,referrer:window.location};v.get("https://dev.mcorp.no/magic.py/get_groupcontext",
l,function(a){k.profile&&(h.request_groupcontextSuccess=performance.now());"error"===a.result?(console.log("group_context failed, trying normal:",a),C()):(g=(new Date).getTime(),Q(a,b,g),K(a),y("https://dev.mcorp.no/magic.py/get_groupcontext",l,!1),p.set(t.CTX),k.profile&&(h.state_context=performance.now()))},C)}else C();if(window.chrome){var n;a=function(){if(chrome.cast&&chrome.cast.isAvailable){clearInterval(n);var a=new chrome.cast.SessionRequest("C95AB3AB"),a=new chrome.cast.ApiConfig(a,function(a){a.addUpdateListener(function(a){j=
a;e("castbusy",a)});B=a;j=!0;e("castbusy",!0)},function(a){"available"===a?(e("cancast",!0),j=!1,m=!0,e("castbusy",j)):e("cancast",!1)},chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED);chrome.cast.initialize(a,function(){chrome.cast.addReceiverActionListener(function(a,b){if("cast"===b){var d=function(a){a&&(q("castbusy",d),M())};D("castbusy",d)}})},function(a){console.log("ERROR",a)});return!0}return!1};a()||(n=setInterval(a,100))}return f};f.logout=function(){x&&(window.location=x)};f.get_msv_by_url=function(b,
d,e){if(!b||!d)throw"Need nickname and url";if(void 0!==a[b])throw"Already have msv "+b;a[b]=MSV.get_msvs([d],e,k.ssl)[0];return a[b]};f.getAssociation=function(a,b,d){v.get("https://dev.mcorp.no/magic.py/get_association",{id:a,referrer:window.location},b,d)};f.setAssociation=function(a,b,d,e){a={id:a,value:JSON.stringify(b),referrer:window.location};v.get("https://dev.mcorp.no/magic.py/set_association",a,d,e)};f.canCast=function(){return m};f.cast=function(a,b,f){if(!m)throw Error("No ChromeCast support");
if(!a&&!k.castURL)throw Error("Need URL to cast");B&&B.stop();V(function(g){"error"===g.result?f(g.message):(d=g.sid,chrome.cast.requestSession(function(d){B=d;B.addUpdateListener(function(a){j=a;e("castbusy",a)});M(a,b,f)},function(a){console.log("Session request failed:",a)}))})};f.stopCast=function(){B&&B.stop()};f.get_session=function(a,b){console("WARNING: Deprecated get_session, use getSession");V(a,b)};f.getSession=V;return f};g.user=function(g,k){v.get("https://dev.mcorp.no/magic.py/get_user_info",
{referrer:window.location},function(f){"signin"===f.error?window.location=f.url:"error"===f.error?k("Bad user - something internal"):g(f)},k)};return g}(MCorp||{});
